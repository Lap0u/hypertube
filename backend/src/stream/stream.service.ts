import { Injectable, Logger } from '@nestjs/common';
import * as torrentStream from 'torrent-stream';
import { Readable } from 'stream';

@Injectable()
export class StreamService {
	private readonly logger = new Logger(StreamService.name)

	streamTorrent(magnetLink: string, dl: boolean): Promise<Readable> {
		return new Promise((resolve, reject) => {
			let fileIndex = 0
			magnetLink = "magnet:?xt=urn:btih:" + magnetLink + "&tr=http%3A%2F%2F125.227.35.196%3A6969%2Fannounce&tr=http%3A%2F%2F210.244.71.25%3A6969%2Fannounce&tr=http%3A%2F%2F210.244.71.26%3A6969%2Fannounce&tr=http%3A%2F%2F213.159.215.198%3A6970%2Fannounce&tr=http%3A%2F%2F37.19.5.139%3A6969%2Fannounce&tr=http%3A%2F%2F37.19.5.155%3A6881%2Fannounce&tr=http%3A%2F%2F46.4.109.148%3A6969%2Fannounce&tr=http%3A%2F%2F87.248.186.252%3A8080%2Fannounce&tr=http%3A%2F%2Fasmlocator.ru%3A34000%2F1hfZS1k4jh%2Fannounce&tr=http%3A%2F%2Fbt.evrl.to%2Fannounce&tr=http%3A%2F%2Fbt.rutracker.org%2Fann&tr=https%3A%2F%2Fwww.artikelplanet.nl&tr=http%3A%2F%2Fmgtracker.org%3A6969%2Fannounce&tr=http%3A%2F%2Fpubt.net%3A2710%2Fannounce&tr=http%3A%2F%2Ftracker.baravik.org%3A6970%2Fannounce&tr=http%3A%2F%2Ftracker.dler.org%3A6969%2Fannounce&tr=http%3A%2F%2Ftracker.filetracker.pl%3A8089%2Fannounce&tr=http%3A%2F%2Ftracker.grepler.com%3A6969%2Fannounce&tr=http%3A%2F%2Ftracker.mg64.net%3A6881%2Fannounce&tr=http%3A%2F%2Ftracker.tiny-vps.com%3A6969%2Fannounce&tr=http%3A%2F%2Ftracker.torrentyorg.pl%2Fannounce&tr=udp%3A%2F%2F168.235.67.63%3A6969&tr=udp%3A%2F%2F182.176.139.129%3A6969&tr=udp%3A%2F%2F37.19.5.155%3A2710&tr=udp%3A%2F%2F46.148.18.250%3A2710&tr=udp%3A%2F%2F46.4.109.148%3A6969&tr=udp%3A%2F%2Fcomputerbedrijven.bestelinks.nl%2F&tr=udp%3A%2F%2Fcomputerbedrijven.startsuper.nl%2F&tr=udp%3A%2F%2Fcomputershop.goedbegin.nl%2F&tr=udp%3A%2F%2Fc3t.org&tr=udp%3A%2F%2Fallerhandelenlaag.nl&tr=udp%3A%2F%2Ftracker.openbittorrent.com%3A80&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=udp%3A%2F%2Ftracker.publicbt.com%3A80&tr=udp%3A%2F%2Ftracker.tiny-vps.com%3A6969"
			this.logger.log(`magnet link = ${magnetLink}`)
			const engine = torrentStream(magnetLink);

			engine.on('ready', () => {
				this.logger.log('Torrent ready for streaming');
				const file = engine.files[fileIndex];

				if (!file) {
					engine.destroy();
					return reject(new Error(`File at index ${fileIndex} not found in torrent`));
				}

				this.logger.log(`Streaming file: ${file.name} (size: ${file.length})`);
				if (!dl) {
					resolve(file.createReadStream());
					this.logger.log('Streaming ...')
					// engine.remove()
				}
				else {
					file.select()
					this.logger.log('Downloading ...')
				}
			});

			engine.on('error', (error) => {
				this.logger.error('Error :', error.message);
				engine.destroy();
				reject(error);
			});
		});
	}
}


// 3FBFACC87CC7108B60BB64D5C3A38FBB8226B21E